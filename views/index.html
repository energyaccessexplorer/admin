<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">

    <script src="/config.js"></script>
    <script src="/lib/duck-tape/duck-tape-bundle.js"></script>

    <link rel="shortcut icon" type="image/png" href="/images/favicon.png"/>

    <title>Energy Access :: Admin</title>
  </head>

  <body>
    <main>
      <nav>
        <a href="/?model=countries">Countries</a>

        <a href="/?model=categories">Categories</a>
      </nav>
    </main>
  </body>

  <script>
    dt_fetchables = {
      "countries": {
        primary: 'ccn3',
        placeholder: "name or ccn3",
        handler: function(v, fill_target) {
          dt_string_fetch_handler({
            table: 'countries',
            query: `select=id,name&name=ilike.*${v}*`,
            input: x => x['id'],
            descriptor: x => x['name'],
            value: v,
            threshold: 2,
            fill_target: fill_target
          });
        }
      },

      "categories": {
        primary: 'id',
        placeholder: "name",
        handler: function(v, fill_target) {
          dt_string_fetch_handler({
            table: 'categories',
            query: `select=id,name,name_long,unit&name=ilike.*${v}*`,
            input: x => x['id'],
            descriptor: x => `${x.name} - ${x.name_long}`,
            value: v,
            threshold: 2,
            fill_target: fill_target
          });
        }
      },

      "files": {
        primary: 'id',
        placeholder: "label (optional)",
        handler: function(v, fill_target) {
          let em = location.get_query_param('edit_model');

          let dataset_param = '';
          let label_param = '';

          if (dt_model === 'datasets' && em.match(UUID_REGEXP))
            dataset_param = `dataset_id=eq.${em}`;

          if (v === '' || v === null) ;
          else
            label_param = `&label=ilike.*${v}*`

          dt_string_fetch_handler({
            table: 'files',
            query: `select=id,label,endpoint&${dataset_param}${label_param}`,
            input: x => x['id'],
            descriptor: x => `${x.label} - ${x.endpoint}`,
            value: v,
            threshold: 0,
            fill_target: fill_target
          });
        }
      },

      "id": {
        placeholder: "uuid",
        handler: function(tablename, v, descriptor) {
          dt_reverse_string_fetch_handler(
            tablename,
            `${tablename}?select=id,${descriptor}&id=eq.${v}`,
            (x) => x['id'],
            (x) => x[descriptor],
            v, 36
          );
        }
      },
    };
  </script>
</html>
